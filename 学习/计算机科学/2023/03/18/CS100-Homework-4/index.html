<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/soundwave.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/soundwave.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/soundwave.svg">
  <link rel="mask-icon" href="/images/soundwave.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-bounce.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zivmax.top","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Problems:  String and Character Manipulation Memory Leak Checker">
<meta property="og:type" content="article">
<meta property="og:title" content="CS100 Homework [4]">
<meta property="og:url" content="https://zivmax.top/%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2023/03/18/CS100-Homework-4/index.html">
<meta property="og:site_name" content="青山后小塘">
<meta property="og:description" content="Problems:  String and Character Manipulation Memory Leak Checker">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-03-18T13:43:56.000Z">
<meta property="article:modified_time" content="2023-03-19T03:46:40.205Z">
<meta property="article:author" content="Zivmax">
<meta property="article:tag" content="C 语言">
<meta property="article:tag" content="CS100">
<meta property="article:tag" content="作业">
<meta property="article:tag" content="上科大">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://zivmax.top/%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2023/03/18/CS100-Homework-4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>CS100 Homework [4] | 青山后小塘</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <!-- require APlayer -->
  <link rel="stylesheet" href="/dist/APlayer.min.css"media="all">
  <div id="aplayer"></div>
  <script src="/dist/APlayer.min.js"></script>

<link rel="alternate" href="/atom.xml" title="青山后小塘" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">

  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta custom-logo">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">青山后小塘</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">人生如逆旅，我亦是行人</p>
      <a>
        <img class="custom-logo-image" src="/uploads/cib-boeing.svg" alt="青山后小塘">
      </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">22</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">26</span></a>

  </li>
        <li class="menu-item menu-item-playlist">

    <a href="/playlist/" rel="section"><i class="fa fa-music fa-fw"></i>歌单</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zivmax.top/%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2023/03/18/CS100-Homework-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Zivmax">
      <meta itemprop="description" content="记录我在SHTU的所见所闻,以及成长">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青山后小塘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CS100 Homework [4]
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间: 2023-03-18 21:43:56" itemprop="dateCreated datePublished" datetime="2023-03-18T21:43:56+08:00">2023-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间: 2023-03-19 11:46:40" itemprop="dateModified" datetime="2023-03-19T11:46:40+08:00">2023-03-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">计算机科学</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:32</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><strong>Problems</strong>:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://cs100.geekpie.club/p/P401?tid=641599c647556d5d171f0718">String and Character Manipulation</a></li>
<li><a target="_blank" rel="noopener" href="https://cs100.geekpie.club/p/23?tid=641599c647556d5d171f0718">Memory Leak Checker</a></li>
</ul>
<span id="more"></span>
<hr>
<h1 id="String-and-Character-Manipulation">String and Character Manipulation</h1>
<p>It is often a good exercise to implement your own versions of some standard library functions. In this task, you need to implement some standard library functions related to character and string manipulations.</p>
<p>The functions you need to implement are listed below.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hw4_islower</span><span class="params">(<span class="type">int</span> ch)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">hw4_isupper</span><span class="params">(<span class="type">int</span> ch)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">hw4_isalpha</span><span class="params">(<span class="type">int</span> ch)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">hw4_isdigit</span><span class="params">(<span class="type">int</span> ch)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">hw4_tolower</span><span class="params">(<span class="type">int</span> ch)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">hw4_toupper</span><span class="params">(<span class="type">int</span> ch)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">hw4_strlen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">hw4_strchr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str, <span class="type">int</span> ch)</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">hw4_strcpy</span><span class="params">(<span class="type">char</span> *dest, <span class="type">const</span> <span class="type">char</span> *src)</span>;</span><br><span class="line"><span class="type">char</span> *<span class="title function_">hw4_strcat</span><span class="params">(<span class="type">char</span> *dest, <span class="type">const</span> <span class="type">char</span> *src)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">hw4_strcmp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *lhs, <span class="type">const</span> <span class="type">char</span> *rhs)</span>;</span><br></pre></td></tr></table></figure>
<p>Your implementations should conform to the C standard. The standard documentations and examples on these functions can be found at <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/string/byte">https://en.cppreference.com/w/c/string/byte</a>. <strong>Do not trust materials from any other sources like Wikipedia, Baidu Zhidao, CSDN, Zhihu, etc.</strong></p>
<p>Note that:</p>
<ul>
<li>All functions' return types, parameter declarations and behaviors should meet the requirements in the cppreference pages (accessible via the link above). The function names are prefixed <code>hw_</code> to avoid name collisions.</li>
<li>Be careful: The cppreference website contains both C and C++ documentations. Refer to the C documentation pages instead of the C++ ones. C and C++ have slight differences and are not fully compatible.</li>
<li>You may ignore the <code>restrict</code> qualifier on the pointer parameters of <code>strlen</code> , <code>strchr</code> , <code>strcpy</code> , <code>strcat</code> and <code>strcmp</code>.</li>
<li>Due to backward compatibility issues, the C standard requires <code>strchr</code> to return <code>char *</code> instead of <code>const char *</code>. To disable the warning about &quot;discarded qualifiers&quot;, just use an explicit cast like <code>char *pos = (char *)str;</code> or <code>return (char *)str;</code>.</li>
<li>The behaviors of some functions are subject to locale settings, as is mentioned by the standard documentations. <strong>You only need to work under the default locale (<code>&quot;C&quot;</code>).</strong></li>
<li>It is not allowed to use any standard library functions. You must implement everything on your own.</li>
<li>It is guaranteed that the tests do not lead to undefined behaviors.</li>
</ul>
<p>Moreover, you need to make your implementation <strong>as simplified as possible</strong>. In details:</p>
<ul>
<li>For <code>hw4_islower</code> , <code>hw4_isupper</code> , <code>hw4_isalpha</code> , <code>hw4_isdigit</code> , <code>hw4_tolower</code> and <code>hw4_toupper</code> , the function body should contain <strong>only one statement</strong>, which is a <code>return</code> statement.</li>
<li>For <code>hw4_strlen</code> , <code>hw4_strchr</code> , <code>hw4_strcpy</code> , <code>hw4_strcat</code> and <code>hw4_strcmp</code> , these functions should be no more complex than a single pass of the given strings. You can't scan the strings over and over again, or go back and forth between some positions. <strong>For example, if your <code>hw4_strlen</code> traverses the whole string to count the number of characters, you can't call it in <code>strcmp</code> to simply obtain the length of the strings, because you still need to traverse the strings to do the comparison.</strong></li>
<li>You may define helper functions, but make sure they are necessary and meaningful.</li>
</ul>
<h2 id="Submission-and-grading">Submission and grading</h2>
<p>On the OJ, submit your code containing the definitions of the functions. Do not include the <code>main</code> function in your submission. The OJ will check whether your implementations are correct.</p>
<p>We will have an off-line check after the deadline. You will need to explain your implementations to your TAs. The grade for this problem is the combination of the results on OJ and that of the off-line check.</p>
<p>Violation of certain rules will not be detected on OJ. For example, you may get full score on OJ if you call the standard library versions of these functions directly, but this will result in zero points in the end.</p>
<h2 id="Samples">Samples</h2>
<p>No samples will be provided here, because the cppreference pages already have many.</p>
<hr>
<h1 id="Memory-Leak-Checker">Memory Leak Checker</h1>
<h2 id="Background-You-d-better-not-skip-this-There-is-some-useful-information-here">Background (You'd better not skip this. There is some useful information here.)</h2>
<p>Making a C program memory-safe is too hard! You need to make sure every memory access is valid, and that all the dynamically allocated memory is correctly deallocated (freed). Is there a tool that can check the memory management automatically, so that memory-related bugs can be detected without manual debugging all day long?</p>
<p>Well, we do have some quite effective tools for detecting these annoying bugs. GCC and Clang have <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a> (<a target="_blank" rel="noopener" href="https://www.usenix.org/conference/atc12/technical-sessions/presentation/serebryany">paper</a>) and <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UndefinedBehaviorSanitizer</a>. Clang also has <a target="_blank" rel="noopener" href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer</a>. <a target="_blank" rel="noopener" href="https://valgrind.org/">Valgrind</a> is a well-known suite of tools for detecting memory management and threading bugs, but it is only supported on Linux and Mac OS X. But Windows users don't have to be frustrated, because <a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com">Visual Studio</a>, <strong>the best IDE in the world</strong>, has all these tools and can handle everything for you.</p>
<h2 id="Description">Description</h2>
<p>In this problem, you will write a very simple tool for detecting memory leaks and invalid calls to <code>free</code>. <strong>Memory leak</strong> happens when some blocks of memory have been allocated on heap (by <code>malloc</code> , <code>calloc</code> , <code>realloc</code> or <code>aligned_alloc</code>) but are not freed. A call to <code>free</code> with argument <code>ptr</code> is <strong>valid</strong> if and only if</p>
<ul>
<li><code>ptr</code> is a null pointer, or</li>
<li><code>ptr</code> is a pointer that is returned by a previous call to <code>malloc</code> , <code>calloc</code> , <code>realloc</code> or <code>aligned_alloc</code> , and it is the first time it is passed to <code>free</code>.</li>
</ul>
<p>Before starting, make sure you have read the cppreference page on <a href="en/cppreference.com/w/c/memory/malloc">malloc</a>, <a href="en.cppreference.com/w/c/memory/calloc">calloc</a> and <a href="en.cppreference.com/w/c/memory/free">free</a>. You can ignore the paragraphs about thread-safety and &quot;synchronization-with&quot;. <strong>Do not trust materials from any other sources like Wikipedia, Baidu Zhidao, CSDN, Zhihu, etc.</strong></p>
<h3 id="Main-ideas">Main ideas</h3>
<p>The idea of detecting memory leaks is straightforward:</p>
<ul>
<li>First, we need to record every call to <code>malloc</code> and <code>calloc</code>. We may use some data structure (e.g. an array) to store the addresses of allocated memory.
<ul>
<li>Since most of you have little knowledge about other fancy data structures (e.g. hash-tables), using an array is enough for this homework.</li>
<li>To simplify the task, you don't need to care about <code>realloc</code> or <code>aligned_alloc</code>.</li>
</ul>
</li>
<li>When <code>free(ptr)</code> is called, check whether <code>ptr</code> exists in the array.
<ul>
<li>If the array contains this address, this is a valid operation. It is safe to deallocate the memory, and we may just remove the corresponding record from the array. (Note: To remove a record from the array, we recommend you simply set the recorded pointer to <code>NULL</code>.)</li>
<li>If not, this call to <code>free</code> is invalid, and you should print some error message.</li>
</ul>
</li>
<li>When the program is terminating, go through the whole array and check whether anything remains in it. Memory leak happens if the array still contains any non-null pointers, and in this case you should print some information about these pointers.</li>
</ul>
<h3 id="Obtaining-additional-information">Obtaining additional information</h3>
<p>It is of great help if you can record not only the address of the allocated memory, but also some other information, like the name of the source file and the line number. For example, you may want to see an error message like</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 bytes memory not freed (allocated in file hw3_problem1.c, line 32)</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invalid free in file hw3_problem1.c, line 49</span><br></pre></td></tr></table></figure>
<p>To achieve this, our array element should be a <code>struct</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_RECORDS 1000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Record</span> </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">void</span> *ptr;              <span class="comment">// address of the allocated memory</span></span><br><span class="line">    <span class="type">size_t</span> size;            <span class="comment">// size of the allocated memory</span></span><br><span class="line">    <span class="type">int</span> line_no;            <span class="comment">// line number, at which a call to malloc or calloc happens</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *file_name;  <span class="comment">// name of the file, in which the call to malloc or calloc happens</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Record</span> <span class="title">records</span>[<span class="title">MAX_RECORDS</span>];</span></span><br></pre></td></tr></table></figure>
<p>How do we obtain the file name and the line number? The C standard provides the macros <code>__LINE__</code> and <code>__FILE__</code>. You can try on your own (in <code>line_and_file.c</code>) to see what they represent:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, __FILE__);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>See <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/preprocessor/replace#Predefined_macros">this webpage</a> for standard definitions of <code>__LINE__</code> and <code>__FILE__</code>.</p>
<p>Now here is how the magic happens: we use <code>#define</code> to replace the calls to <code>malloc</code> , <code>calloc</code> and <code>free</code> , so that these operations can be captured by us:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">recorded_malloc</span><span class="params">(<span class="type">size_t</span> size, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> *file)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="keyword">if</span> (ptr != <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// record this allocation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">recorded_calloc</span><span class="params">(<span class="type">size_t</span> cnt, <span class="type">size_t</span> each_size, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> *file)</span> &#123;</span><br><span class="line">    <span class="type">void</span> *ptr = <span class="built_in">calloc</span>(cnt, each_size);</span><br><span class="line">    <span class="keyword">if</span> (ptr != <span class="literal">NULL</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// record this allocation</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">recorded_free</span><span class="params">(<span class="type">void</span> *ptr, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> *file)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> malloc(SIZE) recorded_malloc(SIZE, __LINE__, __FILE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> calloc(CNT, EACH_SIZE) recorded_calloc(CNT, EACH_SIZE, __LINE__, __FILE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> free(PTR) recorded_free(PTR, __LINE__, __FILE__)</span></span><br></pre></td></tr></table></figure>
<h3 id="Leak-checking">Leak checking</h3>
<p>In the end, we need to check whether all allocated blocks of memory have been freed. This should be done when the program terminates. To force a function to be called on termination, we need another &quot;black magic&quot;:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">check_leak</span><span class="params">(<span class="type">void</span>)</span> __<span class="title function_">attribute__</span><span class="params">((destructor))</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_leak</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Traverse your array to see whether any allocated memory is not freed.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>With an additional declaration marked by <code>__attribute__((destructor))</code> , this function will be called automatically when the program terminates. You may try the following code (in <code>destructor.c</code>) on your own:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fun</span><span class="params">(<span class="type">void</span>)</span> __<span class="title function_">attribute__</span><span class="params">((destructor))</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">fun</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Goodbye world!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Even though the <code>main</code> function is empty, this program will print <code>Goodbye world!</code>.</p>
<h3 id="Usage">Usage</h3>
<p>This is what we want to achieve: Place the code you wrote in a header file <code>memcheck.h</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memcheck.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CS100_MEMCHECK_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CS100_MEMCHECK_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_RECORDS 1000</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Record</span> &#123;</span> <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Record</span> <span class="title">records</span>[<span class="title">MAX_RECORDS</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">recorded_malloc</span><span class="params">(<span class="comment">/* ... */</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">recorded_calloc</span><span class="params">(<span class="comment">/* ... */</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">recorded_free</span><span class="params">(<span class="comment">/* ... */</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_leak</span><span class="params">(<span class="type">void</span>)</span> __<span class="title function_">attribute__</span><span class="params">((destructor))</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_leak</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> malloc(SIZE) recorded_malloc(SIZE, __LINE__, __FILE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> calloc(CNT, EACH_SIZE) recorded_calloc(CNT, EACH_SIZE, __LINE__, __FILE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> free(PTR) recorded_free(PTR, __LINE__, __FILE__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// CS100_MEMCHECK_H</span></span></span><br></pre></td></tr></table></figure>
<p>Then, <code>#include &quot;memcheck.h&quot;</code> in the file you want to check:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Suppose this is my_code.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;memcheck.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Some code that may have memory problems:</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> **p = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">int</span> *) * <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i != <span class="number">5</span>; ++i)</span><br><span class="line">        p[i] = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">int</span>) * <span class="number">3</span>); </span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">free</span>(p[<span class="number">2</span>] + <span class="number">3</span>); <span class="comment">// Suppose this is line 11</span></span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Compile and run <code>my_code.c</code>. The output should be:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Invalid free in file my_code.c, line 11</span><br><span class="line">Summary:</span><br><span class="line">12 bytes memory not freed (allocated in file my_code.c, line 10)</span><br><span class="line">12 bytes memory not freed (allocated in file my_code.c, line 10)</span><br><span class="line">12 bytes memory not freed (allocated in file my_code.c, line 10)</span><br><span class="line">12 bytes memory not freed (allocated in file my_code.c, line 10)</span><br><span class="line">12 bytes memory not freed (allocated in file my_code.c, line 10)</span><br><span class="line">5 allocation records not freed (60 bytes in total).</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="Detailed-requirements">Detailed requirements</h2>
<p>The detailed requirements on how you should deal with certain situations and what to print are as follows.</p>
<ul>
<li><code>free(NULL)</code> should do nothing.</li>
<li>If <code>malloc</code> or <code>calloc</code> returns <code>NULL</code> (indicating failure), no memory is allocated and nothing should be recorded.</li>
<li>When an invalid <code>free</code> happens, you should (in the function <code>recorded_free</code>)
<ul>
<li>
<p>detect it, and output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invalid free in file FILENAME, line N</span><br></pre></td></tr></table></figure>
<p>with a newline (<code>'\n'</code>) at the end, where <code>FILENAME</code> is replaced with the file name, and <code>N</code> is replaced with the line number, and</p>
</li>
<li>
<p><strong>prevent the call to the real <code>free</code> function</strong>, so that no invalid <code>free</code>s actually happen.</p>
</li>
</ul>
</li>
<li>When the program terminates (i.e., in the function <code>leak_check</code>), you should make a summary of the memory usage of this program:
<ul>
<li>
<p>First, output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Summary:</span><br></pre></td></tr></table></figure>
<p>with a newline at the end.</p>
</li>
<li>
<p>Traverse your array to see whether any memory is not freed. For each such record, output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">M bytes memory not freed (allocated in file FILENAME, line N)</span><br></pre></td></tr></table></figure>
<p>with a newline at the end, where <code>M</code> is replaced with the size (in bytes) of that block of memory, <code>FILENAME</code> is replaced with the file name, and <code>N</code> is replaced with the line number. <strong>These lines can be printed in any order.</strong> You don't need to care about singular/plural forms of &quot;byte&quot;. Just print <code>bytes</code> even if <code>M == 1</code>.</p>
</li>
<li>
<p>As a conclusion, if memory leak is detected, output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">N allocation records not freed (M bytes in total).</span><br></pre></td></tr></table></figure>
<p>with a newline at the end, where <code>N</code> is replaced with the number of allocation records that are not freed, and <code>M</code> is replaced with the total size (in bytes) of memory leaked. You don't need to care about singular/plural forms of &quot;record&quot;. Just print <code>records</code> even if <code>N == 1</code>.</p>
<p>If there is no memory leak, output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">All allocations have been freed.</span><br></pre></td></tr></table></figure>
<p>with a newline at the end.</p>
</li>
</ul>
</li>
</ul>
<h2 id="Special-things-you-should-know">Special things you should know</h2>
<ul>
<li>
<p>The behaviors of <code>malloc(0)</code> , <code>calloc(0, N)</code> and <code>calloc(N, 0)</code> are <strong>implementation-defined</strong>. They may return a null pointer (with no memory allocated), but they may also allocate <em>some</em> memory and return a pointer to it. Whenever the returned pointer is non-null, it should be recorded, and <strong>it is also considered as memory leak if that memory is not freed</strong>.</p>
</li>
<li>
<p>Due to alignment requirements or some other possible reasons, <code>malloc</code> and <code>calloc</code> may allocate more memory than you expect. For example, <code>calloc(N, M)</code> may allocate more than <code>N * M</code> bytes of memory, and <code>malloc(0)</code> may allocate some memory, as has been mentioned. But you don't need to consider these complex things - just count <code>N</code> for <code>malloc(N)</code> and <code>N * M</code> for <code>calloc(N, M)</code>. In other words, the following is a possible summary output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Summary:</span><br><span class="line">0 bytes memory not freed (allocated in file a.c, line 10)</span><br><span class="line">1 allocation records not freed (0 bytes in total).</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Notes">Notes</h2>
<ul>
<li>We have provided you with a template code <code>memcheck.c</code> that contains everything mentioned above.</li>
<li>It is guaranteed that the total number of calls to <code>malloc</code> and <code>calloc</code> will not exceed <code>MAX_RECORDS</code> , which is <code>1000</code>.</li>
<li>Feel free to add other helper functions, if you need. <strong>Contact us if you encounter name collision problems.</strong></li>
<li>You may try some fancy data structures, like linked-lists or hash-tables, to optimize the time- and space-complexity. But these will <strong>not</strong> give you additional (bonus) points.</li>
</ul>
<h2 id="Samples-2">Samples</h2>
<h3 id="Sample-program-1">Sample program 1</h3>
<p><code>sample1.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;memcheck.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> **matrix = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">int</span> *) * <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i != <span class="number">10</span>; ++i)</span><br><span class="line">        matrix[i] = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">int</span>) * <span class="number">5</span>);</span><br><span class="line">    <span class="comment">// do some calculations</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i != <span class="number">10</span>; ++i)</span><br><span class="line">        <span class="built_in">free</span>(matrix[i]);</span><br><span class="line">    <span class="built_in">free</span>(matrix);</span><br><span class="line">    matrix = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">free</span>(matrix); <span class="comment">// free(NULL) should do nothing</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Summary:</span><br><span class="line">All allocations have been freed.</span><br></pre></td></tr></table></figure>
<h3 id="Sample-program-2">Sample program 2</h3>
<p><code>sample2.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;memcheck.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Use __attribute__((__unused__)) to suppress warning on unused variable &#x27;p&#x27;.</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">happy</span><span class="params">(<span class="type">void</span> *p __attribute__((__unused__)))</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">double</span> *p = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">double</span>) * <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">free</span>(p + <span class="number">10</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="type">char</span> *q = <span class="built_in">calloc</span>(<span class="number">10</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="type">float</span> *r = <span class="built_in">malloc</span>(<span class="number">0</span>);</span><br><span class="line">    happy(q);</span><br><span class="line">    happy(r);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Possible output: (The line numbers may be different)</strong></p>
<p>If <code>malloc(0)</code> allocates some memory and returns a non-null pointer, the output should be</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Invalid free in file sample2.c, line 9</span><br><span class="line">Invalid free in file sample2.c, line 11</span><br><span class="line">Summary:</span><br><span class="line">10 bytes memory not freed (allocated in file sample2.c, line 12)</span><br><span class="line">0 bytes memory not freed (allocated in file sample2.c, line 13)</span><br><span class="line">2 allocation records not freed (10 bytes in total).</span><br></pre></td></tr></table></figure>
<p>If <code>malloc(0)</code> does not allocate any memory and returns a null pointer, the output should be</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Invalid free in file sample1.c, line 8</span><br><span class="line">Invalid free in file sample1.c, line 10</span><br><span class="line">Summary:</span><br><span class="line">10 bytes memory not freed (allocated in file sample1.c, line 12)</span><br><span class="line">1 allocation records not freed (10 bytes in total).</span><br></pre></td></tr></table></figure>
<h2 id="Submission">Submission</h2>
<p>Submit your <code>memcheck.h</code> to OJ (or copy and paste its contents).</p>
<h2 id="Going-further">Going further</h2>
<p>So far, so good. You have written something that you can really make use of. Although its function is limited, it can be easily extended using the same or a similar idea. For example:</p>
<ul>
<li>Add support for <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/memory/realloc"><code>realloc</code></a> and <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/memory/aligned_alloc"><code>aligned_alloc</code></a>, and maybe also for C23 <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/memory/free_sized"><code>free_sized</code></a> and <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/c/memory/free_aligned_sized"><code>free_aligned_sized</code></a>.</li>
<li>Detect double-free among the invalid <code>free</code> calls. &quot;Double-free&quot; typically refers to a call <code>free(ptr)</code> in which the memory pointed to by <code>ptr</code> has already been freed.</li>
</ul>
<p>Furthermore, the way we replace <code>malloc</code> , <code>calloc</code> and <code>free</code> with our own functions is through the preprocessor directive <code>#define</code> , which is somewhat weak and may cause problems. For example, every source code file we want to check must <code>#include &quot;memcheck.h&quot;</code> , which may cause redefinition of symbols at link-time. User code may also escape from this by simply <code>#undef</code> these macros.</p>
<p>A possibly better solution is to hack the <strong>dynamic linking</strong> of these functions, e.g. using some magic provided by <code>&lt;dlfcn.h&gt;</code> , or the <a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Hooks-for-Malloc.html">malloc hooks</a> provided by the GNU C library. STFW (Search the Friendly Web) on your own.</p>
<p>There are some language constructs in C++ that allow user-declared replacements for memory allocation and deallocation functions ( <code>operator new</code> and <code>operator delete</code> ), so that you don't have to do it in a &quot;hacky&quot; manner. See <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV17N4y1u7Cn/?spm_id_from=333.999.0.0">my video</a> for details.</p>
<p><em><strong>Attachments of this problems</strong></em>:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/zivmax/CS100-homework-attachments/tree/main/hw_4_pro_2_attachments">👉 Go to GitHub</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C-%E8%AF%AD%E8%A8%80/" rel="tag"># C 语言</a>
              <a href="/tags/CS100/" rel="tag"># CS100</a>
              <a href="/tags/%E4%BD%9C%E4%B8%9A/" rel="tag"># 作业</a>
              <a href="/tags/%E4%B8%8A%E7%A7%91%E5%A4%A7/" rel="tag"># 上科大</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/%E5%AD%A6%E4%B9%A0/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/2023/03/17/%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80-1/" rel="prev" title="编程基础 [1]">
      <i class="fa fa-chevron-left"></i> 编程基础 [1]
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#String-and-Character-Manipulation"><span class="nav-text">String and Character Manipulation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Submission-and-grading"><span class="nav-text">Submission and grading</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Samples"><span class="nav-text">Samples</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Memory-Leak-Checker"><span class="nav-text">Memory Leak Checker</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Background-You-d-better-not-skip-this-There-is-some-useful-information-here"><span class="nav-text">Background (You&#39;d better not skip this. There is some useful information here.)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Description"><span class="nav-text">Description</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Main-ideas"><span class="nav-text">Main ideas</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Obtaining-additional-information"><span class="nav-text">Obtaining additional information</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leak-checking"><span class="nav-text">Leak checking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Usage"><span class="nav-text">Usage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Detailed-requirements"><span class="nav-text">Detailed requirements</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Special-things-you-should-know"><span class="nav-text">Special things you should know</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Notes"><span class="nav-text">Notes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Samples-2"><span class="nav-text">Samples</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sample-program-1"><span class="nav-text">Sample program 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sample-program-2"><span class="nav-text">Sample program 2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Submission"><span class="nav-text">Submission</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Going-further"><span class="nav-text">Going further</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zivmax"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Zivmax</p>
  <div class="site-description" itemprop="description">记录我在SHTU的所见所闻,以及成长</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
          
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zivmax" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zivmax" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:838816519@qq.com" title="E-Mail → mailto:838816519@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="/wechat/" title="Wechat → &#x2F;wechat&#x2F;"><i class="fab fa-weixin fa-fw"></i>Wechat</a>
      </span>
      <span class="links-of-author-item">
        <a href="/QQ/" title="QQ → &#x2F;QQ&#x2F;"><i class="fab fa-qq fa-fw"></i>QQ</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
          
        </div>
  
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022-8-11 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-flag"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zivmax</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>




        








      	  <!-- require MetingJS -->
	      <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
        <meting-js
        server = "netease"
        id = "7585293889"
        type = "playlist" 
        mini = "true"
        fixed = "true"
        list-folded = "true"
        autoplay = "false"
        volume = "0.4"
        theme = "#FADFA3"
        order = "random"
        loop = "all"
        lrc-type = -1
        preload = "auto"
        mutex = "true">
        </meting-js>
      </div>
    </footer>
  </div>

  
  <script color='255,255,255' opacity='0.8' zIndex='-1' count='120' src="/lib/canvas-nest/canvas-nest-nomobile.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  

    </div>


</body>
</html>

